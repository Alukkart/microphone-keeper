name: Build MicKeeper

on: [push]

jobs:
  build_windows:
    name: Build Windows EXE
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: 1.22

      - name: Install PortAudio for Windows
        shell: powershell
        run: |
          # Скачиваем PortAudio для Windows (pre-built)
          $portaudioUrl = "https://files.portaudio.com/archives/portaudio_v18_1.zip"
          $downloadPath = "$env:TEMP\portaudio.zip"
          $extractPath = "$env:TEMP\portaudio"
          
          # Скачиваем и распаковываем
          Invoke-WebRequest -Uri $portaudioUrl -OutFile $downloadPath
          Expand-Archive -Path $downloadPath -DestinationPath $extractPath
          
          # Ищем нужные файлы
          $includeDir = Get-ChildItem -Path $extractPath -Recurse -Filter "*.h" | Select-Object -First 1
          if ($includeDir) {
            $portaudioRoot = $includeDir.Directory.Parent.FullName
            $includePath = "$portaudioRoot\include"
            $libPath = "$portaudioRoot\lib\x64"
          
            # Копируем заголовочные файлы и библиотеки в рабочий каталог
            New-Item -ItemType Directory -Path ".\libs" -Force
            Copy-Item -Path "$includePath\*" -Destination ".\libs\" -Recurse -Force
          
            # Проверяем наличие DLL
            $dllPath = "$libPath\portaudio_x64.dll"
            if (Test-Path $dllPath) {
              Copy-Item -Path $dllPath -Destination ".\libs\portaudio.dll"
            }
          
            # Устанавливаем переменные окружения для CGO
            echo "CGO_CFLAGS=-I$pwd\libs" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            echo "CGO_LDFLAGS=-L$pwd\libs -lportaudio" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          }

      - name: Setup MinGW Compiler
        shell: powershell
        run: |
          # Проверяем, установлен ли уже MinGW
          if (Test-Path "C:\msys64\mingw64\bin\gcc.exe") {
            echo "MinGW already installed"
            echo "PATH=C:\msys64\mingw64\bin;$env:PATH" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          } else {
            # Используем предустановленный MSYS2
            echo "PATH=C:\msys64\usr\bin;C:\msys64\mingw64\bin;$env:PATH" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          }

      - name: Build Windows EXE
        shell: powershell
        run: |
          # Настраиваем окружение для CGO
          $env:CGO_ENABLED = "1"
          $env:CC = "gcc"
          $env:GOOS = "windows"
          $env:GOARCH = "amd64"
          
          # Обновляем модули Go
          go mod tidy
          
          # Пробуем собрать с CGO
          Write-Host "Building with CGO..."
          try {
            go build -ldflags="-H windowsgui" -o mic_keeper.exe
            if (Test-Path mic_keeper.exe) {
              Write-Host "Build with CGO succeeded"
            }
          } catch {
            Write-Host "CGO build failed, trying without CGO..."
            $env:CGO_ENABLED = "0"
            go build -ldflags="-H windowsgui" -o mic_keeper.exe
          }

      - name: Verify and package binary
        shell: powershell
        run: |
          if (Test-Path mic_keeper.exe) {
            Write-Host "✓ Build successful!"
            Write-Host "File size: $((Get-Item mic_keeper.exe).Length / 1MB) MB"
          
            # Копируем необходимые DLL если они есть
            if (Test-Path ".\libs\portaudio.dll") {
              Copy-Item -Path ".\libs\portaudio.dll" -Destination ".\"
              Write-Host "✓ Copied portaudio.dll"
            }
          } else {
            Write-Error "✗ Build failed: mic_keeper.exe not found"
            exit 1
          }

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: mic_keeper_windows
          path: |
            mic_keeper.exe
            portaudio.dll

  build_linux:
    name: Build Linux Binary
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.22"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libportaudio2 portaudio19-dev \
            xorg-dev libgl1-mesa-dev libxcursor-dev \
            libxrandr-dev libxinerama-dev libxi-dev libx11-dev \
            pkg-config

      - name: Build Linux binary
        run: |
          go mod tidy
          CGO_ENABLED=1 GOOS=linux GOARCH=amd64 go build -o mic_keeper

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: mic_keeper_linux
          path: mic_keeper